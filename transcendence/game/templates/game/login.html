<!DOCTYPE html>
<html lang="en">

<head>
	{% load static %}
	{% load env_extra %}
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Login</title>
	<meta name="description" content="">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<link rel="stylesheet" href="{% static 'css/login.css' %}">
	<link rel="stylesheet" href="{% static 'css/base.css' %}">

</head>

{% csrf_token %}

<div class="bg-block block-1"></div>
<div class="bg-block block-2"></div>
<div class="blur-cover"></div>


<div class="form-wrapper">
	<h3 id="form-onglet">REGISTER</h3>

	<div class="form-input-div">
		<label for="username">Username</label>
		<input class="form-input" type="text" id="username" name="username" placeholder="username" minlength="1"
			maxlength="20" />
		<a id="username_error"> Error username must be unique</a>
	</div>

	<div class="form-input-div">
		<label for="password">Password</label>
		<input class="form-input" type="password" id="password" name="password" placeholder="password " minlength="6" />
		<a id="password_error">Error password must be at least 5 character long</a>
	</div>

	<button id="form-action-btn" class="form-action-btn" type="submit" onclick="password_create()">Register</button>
	<div class="form-spacer row">
		<div class="col-4"></div>
		<span class="col-4">or continue with</span>
		<div class="col-4"></div>
	</div>
	<button class="btn-auth-42" onclick="redirect_oauth(); return false;">
		Login with
		<img id="logo_oauth" src="{% static 'images/42_logo.svg' %}" />

	</button>

	<p id="account-msg">Have an account on PONG? <span onclick='switchToLoginPage();'>Log in</span></p>
</div>

<script>
	{% load env_extra %};

	var base_url = "{% get_env_var 'BASE_URL_HTTPS' %}";
	var base_wss = "{% get_env_var 'BASE_URL_WSS' %}";

	function displayUsernameError() {
		document.getElementById("username_error").style.opacity = "1";
		document.getElementById("username").style.borderColor = "red";
	}
	function hideUsernameError() {
		document.getElementById("username_error").style.opacity = "0";
		document.getElementById("username").style.borderColor = "transparent";
	}

	function displayPasswordError() {
		document.getElementById("password_error").style.opacity = "1";
		document.getElementById("password").style.borderColor = "red";
	}
	function hidePasswordError() {
		document.getElementById("password_error").style.opacity = "0";
		document.getElementById("password").style.borderColor = "transparent";
	}

	function switchToLoginPage() {
		hidePasswordError();
		hideUsernameError();
		document.getElementById("form-onglet").innerHTML = "LOGIN";
		document.getElementById("form-action-btn").innerHTML = "Login";
		document.getElementById("form-action-btn").setAttribute('onclick', 'password_auth();');


		document.getElementById("account-msg").innerHTML =
		"Don't have an account on PONG? <span onclick='switchToRegisterPage();'>Sign up</span>";
	}

	function switchToRegisterPage() {
		hidePasswordError();
		hideUsernameError();
		document.getElementById("form-onglet").innerHTML = "REGISTER";
		document.getElementById("form-action-btn").innerHTML = "Register";
		document.getElementById("form-action-btn").setAttribute('onclick', 'password_create();');


		document.getElementById("account-msg").innerHTML =
		"Have an account on PONG? <span onclick='switchToLoginPage();'>Log in</span>";
	}

	async function password_create() {
		username = document.getElementById("username").value;
		password = document.getElementById("password").value;
		hidePasswordError();
		hideUsernameError();
		if (username == "") {
			return;
		} else if (username == "None") {

		}
		if (username.length < 1 || username.length > 20) {
			displayUsernameError();
			document.getElementById("username_error").innerHTML = "Username must be at least 1 character long.";
			return;
		}
		if (password.length < 6) {
			displayPasswordError();
			document.getElementById("password_error").innerHTML = "Password must be at least 6 characters long.";
			return;
		}
		var data = { "username": username, "password": password };
		var url = base_url + "/passwordcreate";
		var token = readCookie('csrftoken');
		var response = await fetch(url, {
			method: "POST",
			credentials: 'same-origin',
			headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token },
			body: JSON.stringify(data)
		});
		if (response.status == 301) {
			displayUsernameError();
			document.getElementById("username_error").innerHTML = "Username is already taken. Please choose another one.";
			return;
		}
		window.location.replace(base_url + "/home");

	}
	async function password_auth() {
		username = document.getElementById("username").value;
		password = document.getElementById("password").value;
		hidePasswordError();
		hideUsernameError();
		if (username == "") {
			return;
		} else if (username == "None") {

		}
		if (username.length < 1 || username.length > 20) {
			displayUsernameError();
			document.getElementById("username_error").innerHTML = "Username must be at least 1 character long.";
			return;
		}
		if (password.length < 6) {
			displayPasswordError();
			document.getElementById("password_error").innerHTML = "Password must be at least 6 characters long.";
			return;
		}
		var data = { "username": username, "password": password };
		var url = base_url + "/passwordlogin";
		var token = readCookie('csrftoken');
		var response = await fetch(url, {
			method: "POST",
			credentials: 'same-origin',
			headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token },
			body: JSON.stringify(data)
		});
		if (response.status == 301) {
			document.getElementById("username").style.borderColor = "red";
			displayPasswordError();
			document.getElementById("password_error").innerHTML = "Incorrect username or password. Please try again.";
			return;
		}
		window.location.replace(base_url + "/home");

	}

	function redirect_oauth() {
		url = base_url + "/loginoauth";
		window.location.replace(url);
		return false;
	}

	function readCookie(name) {
		var nameEQ = name + "=";
		var ca = document.cookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') c = c.substring(1, c.length);
			if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
		}
		return null;
	}
</script>
